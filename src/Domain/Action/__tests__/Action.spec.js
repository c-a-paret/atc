import {Altitude, Heading, HoldingPattern, Landing, Speed, Waypoint} from "../Action";
import {Aeroplane} from "../../Aeroplane/Aeroplane";
import {GameMap} from "../../GameMap/GameMap";
import {MAX_ALTITUDE, MIN_ALTITUDE} from "../../../config/constants";

const testGameMap = () => {
    return new GameMap({
        features: {
            runways: [{
                start: {
                    label: "9L",
                    heading: 90,
                    altitude: 0,
                    landingZone: {
                        x: 510,
                        y: 500,
                    },
                    ILS: {
                        innerMarker: {
                            x: 500,
                            y: 500,
                        },
                        outerMarker: {
                            x: 280,
                            y: 500,
                        }
                    }
                },
                end: {
                    label: "27R",
                    heading: 270,
                    altitude: 0,
                    landingZone: {
                        x: 490,
                        y: 500,
                    },
                    ILS: {
                        innerMarker: {
                            x: 500,
                            y: 550,
                        },
                        outerMarker: {
                            x: 720,
                            y: 550,
                        }
                    }
                }
            }], waypoints: [{type: "VOR", id: "LAM", name: "Lambourne", x: 500, y: 500},]
        }
    })
}

describe("Speed", () => {
    test("Creates speed action with decreasing speed", () => {
        let weight = 3;
        let currentSpeed = 300;
        let desiredSpeed = 290;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, currentSpeed, 90, 5000, weight)

        const action = new Speed({}, aeroplane, desiredSpeed)

        expect(aeroplane.speed).toBe(300)
        action.apply()
        expect(aeroplane.speed).toBe(299)
        action.apply()
        expect(aeroplane.speed).toBe(298)
    })

    test("Creates speed action with increasing speed", () => {
        let weight = 3;
        let currentSpeed = 295;
        let desiredSpeed = 304;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, currentSpeed, 90, 5000, weight)

        const action = new Speed({}, aeroplane, desiredSpeed)

        expect(aeroplane.speed).toBe(295)
        action.apply()
        expect(aeroplane.speed).toBe(296)
        action.apply()
        expect(aeroplane.speed).toBe(297)
    })

    test("Is not valid if the target speed is below 0", () => {
        let desiredSpeed = -12;

        expect(new Speed({}, {speed: 200}, desiredSpeed).isValid()).toBeFalsy()
    })

    test("Is not valid if the target speed is same as current speed", () => {
        let desiredSpeed = 200;

        expect(new Speed({}, {speed: 200}, desiredSpeed).isValid()).toBeFalsy()
    })

    test("Is not valid if the target speed is lower than the minimum speed", () => {
        let desiredSpeed = 10;

        expect(new Speed({}, {speed: 200}, desiredSpeed).isValid()).toBeFalsy()
    })
})

describe("Heading", () => {
    test.each`
    startHeading | targetHeading | firstNewHeading 
    ${0} | ${10} | ${4.4995}
    ${1} | ${11} | ${5.4995}
    ${2} | ${12} | ${6.4995}
    ${3} | ${13} | ${7.4995}
    ${4} | ${14} | ${8.4995}
    ${5} | ${15} | ${9.4995}
    ${6} | ${16} | ${10.4995}
    ${7} | ${17} | ${11.4995}
    ${8} | ${18} | ${12.4995}
    ${9} | ${19} | ${13.4995}
    ${10} | ${20} | ${14.4995}
    ${11} | ${21} | ${15.4995}
    ${12} | ${22} | ${16.4995}
    ${13} | ${23} | ${17.4995}
    ${14} | ${24} | ${18.4995}
    ${15} | ${25} | ${19.4995}
    ${16} | ${26} | ${20.4995}
    ${17} | ${27} | ${21.4995}
    ${18} | ${28} | ${22.4995}
    ${19} | ${29} | ${23.4995}
    ${20} | ${30} | ${24.4995}
    ${21} | ${31} | ${25.4995}
    ${22} | ${32} | ${26.4995}
    ${23} | ${33} | ${27.4995}
    ${24} | ${34} | ${28.4995}
    ${25} | ${35} | ${29.4995}
    ${26} | ${36} | ${30.4995}
    ${27} | ${37} | ${31.4995}
    ${28} | ${38} | ${32.4995}
    ${29} | ${39} | ${33.4995}
    ${30} | ${40} | ${34.4995}
    ${31} | ${41} | ${35.4995}
    ${32} | ${42} | ${36.4995}
    ${33} | ${43} | ${37.4995}
    ${34} | ${44} | ${38.4995}
    ${35} | ${45} | ${39.4995}
    ${36} | ${46} | ${40.4995}
    ${37} | ${47} | ${41.4995}
    ${38} | ${48} | ${42.4995}
    ${39} | ${49} | ${43.4995}
    ${40} | ${50} | ${44.4995}
    ${41} | ${51} | ${45.4995}
    ${42} | ${52} | ${46.4995}
    ${43} | ${53} | ${47.4995}
    ${44} | ${54} | ${48.4995}
    ${45} | ${55} | ${49.4995}
    ${46} | ${56} | ${50.4995}
    ${47} | ${57} | ${51.4995}
    ${48} | ${58} | ${52.4995}
    ${49} | ${59} | ${53.4995}
    ${50} | ${60} | ${54.4995}
    ${51} | ${61} | ${55.4995}
    ${52} | ${62} | ${56.4995}
    ${53} | ${63} | ${57.4995}
    ${54} | ${64} | ${58.4995}
    ${55} | ${65} | ${59.4995}
    ${56} | ${66} | ${60.4995}
    ${57} | ${67} | ${61.4995}
    ${58} | ${68} | ${62.4995}
    ${59} | ${69} | ${63.4995}
    ${60} | ${70} | ${64.4995}
    ${61} | ${71} | ${65.4995}
    ${62} | ${72} | ${66.4995}
    ${63} | ${73} | ${67.4995}
    ${64} | ${74} | ${68.4995}
    ${65} | ${75} | ${69.4995}
    ${66} | ${76} | ${70.4995}
    ${67} | ${77} | ${71.4995}
    ${68} | ${78} | ${72.4995}
    ${69} | ${79} | ${73.4995}
    ${70} | ${80} | ${74.4995}
    ${71} | ${81} | ${75.4995}
    ${72} | ${82} | ${76.4995}
    ${73} | ${83} | ${77.4995}
    ${74} | ${84} | ${78.4995}
    ${75} | ${85} | ${79.4995}
    ${76} | ${86} | ${80.4995}
    ${77} | ${87} | ${81.4995}
    ${78} | ${88} | ${82.4995}
    ${79} | ${89} | ${83.4995}
    ${80} | ${90} | ${84.4995}
    ${81} | ${91} | ${85.4995}
    ${82} | ${92} | ${86.4995}
    ${83} | ${93} | ${87.4995}
    ${84} | ${94} | ${88.4995}
    ${85} | ${95} | ${89.4995}
    ${86} | ${96} | ${90.4995}
    ${87} | ${97} | ${91.4995}
    ${88} | ${98} | ${92.4995}
    ${89} | ${99} | ${93.4995}
    ${90} | ${100} | ${94.4995}
    ${91} | ${101} | ${95.4995}
    ${92} | ${102} | ${96.4995}
    ${93} | ${103} | ${97.4995}
    ${94} | ${104} | ${98.4995}
    ${95} | ${105} | ${99.4995}
    ${96} | ${106} | ${100.4995}
    ${97} | ${107} | ${101.4995}
    ${98} | ${108} | ${102.4995}
    ${99} | ${109} | ${103.4995}
    ${100} | ${110} | ${104.4995}
    ${101} | ${111} | ${105.4995}
    ${102} | ${112} | ${106.4995}
    ${103} | ${113} | ${107.4995}
    ${104} | ${114} | ${108.4995}
    ${105} | ${115} | ${109.4995}
    ${106} | ${116} | ${110.4995}
    ${107} | ${117} | ${111.4995}
    ${108} | ${118} | ${112.4995}
    ${109} | ${119} | ${113.4995}
    ${110} | ${120} | ${114.4995}
    ${111} | ${121} | ${115.4995}
    ${112} | ${122} | ${116.4995}
    ${113} | ${123} | ${117.4995}
    ${114} | ${124} | ${118.4995}
    ${115} | ${125} | ${119.4995}
    ${116} | ${126} | ${120.4995}
    ${117} | ${127} | ${121.4995}
    ${118} | ${128} | ${122.4995}
    ${119} | ${129} | ${123.4995}
    ${120} | ${130} | ${124.4995}
    ${121} | ${131} | ${125.4995}
    ${122} | ${132} | ${126.4995}
    ${123} | ${133} | ${127.4995}
    ${124} | ${134} | ${128.4995}
    ${125} | ${135} | ${129.4995}
    ${126} | ${136} | ${130.4995}
    ${127} | ${137} | ${131.4995}
    ${128} | ${138} | ${132.4995}
    ${129} | ${139} | ${133.4995}
    ${130} | ${140} | ${134.4995}
    ${131} | ${141} | ${135.4995}
    ${132} | ${142} | ${136.4995}
    ${133} | ${143} | ${137.4995}
    ${134} | ${144} | ${138.4995}
    ${135} | ${145} | ${139.4995}
    ${136} | ${146} | ${140.4995}
    ${137} | ${147} | ${141.4995}
    ${138} | ${148} | ${142.4995}
    ${139} | ${149} | ${143.4995}
    ${140} | ${150} | ${144.4995}
    ${141} | ${151} | ${145.4995}
    ${142} | ${152} | ${146.4995}
    ${143} | ${153} | ${147.4995}
    ${144} | ${154} | ${148.4995}
    ${145} | ${155} | ${149.4995}
    ${146} | ${156} | ${150.4995}
    ${147} | ${157} | ${151.4995}
    ${148} | ${158} | ${152.4995}
    ${149} | ${159} | ${153.4995}
    ${150} | ${160} | ${154.4995}
    ${151} | ${161} | ${155.4995}
    ${152} | ${162} | ${156.4995}
    ${153} | ${163} | ${157.4995}
    ${154} | ${164} | ${158.4995}
    ${155} | ${165} | ${159.4995}
    ${156} | ${166} | ${160.4995}
    ${157} | ${167} | ${161.4995}
    ${158} | ${168} | ${162.4995}
    ${159} | ${169} | ${163.4995}
    ${160} | ${170} | ${164.4995}
    ${161} | ${171} | ${165.4995}
    ${162} | ${172} | ${166.4995}
    ${163} | ${173} | ${167.4995}
    ${164} | ${174} | ${168.4995}
    ${165} | ${175} | ${169.4995}
    ${166} | ${176} | ${170.4995}
    ${167} | ${177} | ${171.4995}
    ${168} | ${178} | ${172.4995}
    ${169} | ${179} | ${173.4995}
    ${170} | ${180} | ${174.4995}
    ${171} | ${181} | ${175.4995}
    ${172} | ${182} | ${176.4995}
    ${173} | ${183} | ${177.4995}
    ${174} | ${184} | ${178.4995}
    ${175} | ${185} | ${179.4995}
    ${176} | ${186} | ${180.4995}
    ${177} | ${187} | ${181.4995}
    ${178} | ${188} | ${182.4995}
    ${179} | ${189} | ${183.4995}
    ${180} | ${190} | ${184.4995}
    ${181} | ${191} | ${185.4995}
    ${182} | ${192} | ${186.4995}
    ${183} | ${193} | ${187.4995}
    ${184} | ${194} | ${188.4995}
    ${185} | ${195} | ${189.4995}
    ${186} | ${196} | ${190.4995}
    ${187} | ${197} | ${191.4995}
    ${188} | ${198} | ${192.4995}
    ${189} | ${199} | ${193.4995}
    ${190} | ${200} | ${194.4995}
    ${191} | ${201} | ${195.4995}
    ${192} | ${202} | ${196.4995}
    ${193} | ${203} | ${197.4995}
    ${194} | ${204} | ${198.4995}
    ${195} | ${205} | ${199.4995}
    ${196} | ${206} | ${200.4995}
    ${197} | ${207} | ${201.4995}
    ${198} | ${208} | ${202.4995}
    ${199} | ${209} | ${203.4995}
    ${200} | ${210} | ${204.4995}
    ${201} | ${211} | ${205.4995}
    ${202} | ${212} | ${206.4995}
    ${203} | ${213} | ${207.4995}
    ${204} | ${214} | ${208.4995}
    ${205} | ${215} | ${209.4995}
    ${206} | ${216} | ${210.4995}
    ${207} | ${217} | ${211.4995}
    ${208} | ${218} | ${212.4995}
    ${209} | ${219} | ${213.4995}
    ${210} | ${220} | ${214.4995}
    ${211} | ${221} | ${215.4995}
    ${212} | ${222} | ${216.4995}
    ${213} | ${223} | ${217.4995}
    ${214} | ${224} | ${218.4995}
    ${215} | ${225} | ${219.4995}
    ${216} | ${226} | ${220.4995}
    ${217} | ${227} | ${221.4995}
    ${218} | ${228} | ${222.4995}
    ${219} | ${229} | ${223.4995}
    ${220} | ${230} | ${224.4995}
    ${221} | ${231} | ${225.4995}
    ${222} | ${232} | ${226.4995}
    ${223} | ${233} | ${227.4995}
    ${224} | ${234} | ${228.4995}
    ${225} | ${235} | ${229.4995}
    ${226} | ${236} | ${230.4995}
    ${227} | ${237} | ${231.4995}
    ${228} | ${238} | ${232.4995}
    ${229} | ${239} | ${233.4995}
    ${230} | ${240} | ${234.4995}
    ${231} | ${241} | ${235.4995}
    ${232} | ${242} | ${236.4995}
    ${233} | ${243} | ${237.4995}
    ${234} | ${244} | ${238.4995}
    ${235} | ${245} | ${239.4995}
    ${236} | ${246} | ${240.4995}
    ${237} | ${247} | ${241.4995}
    ${238} | ${248} | ${242.4995}
    ${239} | ${249} | ${243.4995}
    ${240} | ${250} | ${244.4995}
    ${241} | ${251} | ${245.4995}
    ${242} | ${252} | ${246.4995}
    ${243} | ${253} | ${247.4995}
    ${244} | ${254} | ${248.4995}
    ${245} | ${255} | ${249.4995}
    ${246} | ${256} | ${250.4995}
    ${247} | ${257} | ${251.4995}
    ${248} | ${258} | ${252.4995}
    ${249} | ${259} | ${253.4995}
    ${250} | ${260} | ${254.4995}
    ${251} | ${261} | ${255.4995}
    ${252} | ${262} | ${256.4995}
    ${253} | ${263} | ${257.4995}
    ${254} | ${264} | ${258.4995}
    ${255} | ${265} | ${259.4995}
    ${256} | ${266} | ${260.4995}
    ${257} | ${267} | ${261.4995}
    ${258} | ${268} | ${262.4995}
    ${259} | ${269} | ${263.4995}
    ${260} | ${270} | ${264.4995}
    ${261} | ${271} | ${265.4995}
    ${262} | ${272} | ${266.4995}
    ${263} | ${273} | ${267.4995}
    ${264} | ${274} | ${268.4995}
    ${265} | ${275} | ${269.4995}
    ${266} | ${276} | ${270.4995}
    ${267} | ${277} | ${271.4995}
    ${268} | ${278} | ${272.4995}
    ${269} | ${279} | ${273.4995}
    ${270} | ${280} | ${274.4995}
    ${271} | ${281} | ${275.4995}
    ${272} | ${282} | ${276.4995}
    ${273} | ${283} | ${277.4995}
    ${274} | ${284} | ${278.4995}
    ${275} | ${285} | ${279.4995}
    ${276} | ${286} | ${280.4995}
    ${277} | ${287} | ${281.4995}
    ${278} | ${288} | ${282.4995}
    ${279} | ${289} | ${283.4995}
    ${280} | ${290} | ${284.4995}
    ${281} | ${291} | ${285.4995}
    ${282} | ${292} | ${286.4995}
    ${283} | ${293} | ${287.4995}
    ${284} | ${294} | ${288.4995}
    ${285} | ${295} | ${289.4995}
    ${286} | ${296} | ${290.4995}
    ${287} | ${297} | ${291.4995}
    ${288} | ${298} | ${292.4995}
    ${289} | ${299} | ${293.4995}
    ${290} | ${300} | ${294.4995}
    ${291} | ${301} | ${295.4995}
    ${292} | ${302} | ${296.4995}
    ${293} | ${303} | ${297.4995}
    ${294} | ${304} | ${298.4995}
    ${295} | ${305} | ${299.4995}
    ${296} | ${306} | ${300.4995}
    ${297} | ${307} | ${301.4995}
    ${298} | ${308} | ${302.4995}
    ${299} | ${309} | ${303.4995}
    ${300} | ${310} | ${304.4995}
    ${301} | ${311} | ${305.4995}
    ${302} | ${312} | ${306.4995}
    ${303} | ${313} | ${307.4995}
    ${304} | ${314} | ${308.4995}
    ${305} | ${315} | ${309.4995}
    ${306} | ${316} | ${310.4995}
    ${307} | ${317} | ${311.4995}
    ${308} | ${318} | ${312.4995}
    ${309} | ${319} | ${313.4995}
    ${310} | ${320} | ${314.4995}
    ${311} | ${321} | ${315.4995}
    ${312} | ${322} | ${316.4995}
    ${313} | ${323} | ${317.4995}
    ${314} | ${324} | ${318.4995}
    ${315} | ${325} | ${319.4995}
    ${316} | ${326} | ${320.4995}
    ${317} | ${327} | ${321.4995}
    ${318} | ${328} | ${322.4995}
    ${319} | ${329} | ${323.4995}
    ${320} | ${330} | ${324.4995}
    ${321} | ${331} | ${325.4995}
    ${322} | ${332} | ${326.4995}
    ${323} | ${333} | ${327.4995}
    ${324} | ${334} | ${328.4995}
    ${325} | ${335} | ${329.4995}
    ${326} | ${336} | ${330.4995}
    ${327} | ${337} | ${331.4995}
    ${328} | ${338} | ${332.4995}
    ${329} | ${339} | ${333.4995}
    ${330} | ${340} | ${334.4995}
    ${331} | ${341} | ${335.4995}
    ${332} | ${342} | ${336.4995}
    ${333} | ${343} | ${337.4995}
    ${334} | ${344} | ${338.4995}
    ${335} | ${345} | ${339.4995}
    ${336} | ${346} | ${340.4995}
    ${337} | ${347} | ${341.4995}
    ${338} | ${348} | ${342.4995}
    ${339} | ${349} | ${343.4995}
    ${340} | ${350} | ${344.4995}
    ${341} | ${351} | ${345.4995}
    ${342} | ${352} | ${346.4995}
    ${343} | ${353} | ${347.4995}
    ${344} | ${354} | ${348.4995}
    ${345} | ${355} | ${349.4995}
    ${346} | ${356} | ${350.4995}
    ${347} | ${357} | ${351.4995}
    ${348} | ${358} | ${352.4995}
    ${349} | ${359} | ${353.4995}
    ${350} | ${360} | ${354.4995}
    ${351} | ${361} | ${355.4995}
    ${352} | ${362} | ${356.4995}
    ${353} | ${363} | ${357.4995}
    ${354} | ${364} | ${358.4995}
    ${355} | ${365} | ${359.4995}
    ${356} | ${366} | ${0.4995}
    ${357} | ${367} | ${1.4995}
    ${358} | ${368} | ${2.4995}
    ${359} | ${369} | ${3.4995}
    ${360} | ${370} | ${4.4995}    
  `("Turns to $firstNewHeading when facing $startHeading aiming for $targetHeading", ({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            startHeading,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            targetHeading,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            firstNewHeading
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }) => {
        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 220, startHeading, 5000, 1)

        const action = new Heading({}, aeroplane, targetHeading)

        expect(aeroplane.heading).toBe(startHeading)
        action.apply()
        expect(aeroplane.heading).toBeCloseTo(firstNewHeading)
    });

    test("Turning right within circle", () => {
        let currentHeading = 5;
        let desiredHeading = 10;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 220, currentHeading, 5000, 1)

        const action = new Heading({}, aeroplane, desiredHeading)

        expect(aeroplane.heading).toBe(5)
        action.apply()
        expect(aeroplane.heading).toBeCloseTo(9.4995)
        action.apply()
        expect(aeroplane.heading).toBe(10)
    })

    test("Turning left within circle", () => {
        let currentHeading = 10;
        let desiredHeading = 5;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 220, currentHeading, 5000, 1)

        const action = new Heading({}, aeroplane, desiredHeading)

        expect(aeroplane.heading).toBe(10)
        action.apply()
        expect(aeroplane.heading).toBeCloseTo(5.5005)
        action.apply()
        expect(aeroplane.heading).toBe(5)
    })

    test("Turning left outside circle", () => {
        let currentHeading = 5;
        let desiredHeading = 355;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 220, currentHeading, 5000, 1)

        const action = new Heading({}, aeroplane, desiredHeading)

        expect(aeroplane.heading).toBe(5)
        action.apply()
        expect(aeroplane.heading).toBeCloseTo(0.50049)
        action.apply()
        expect(aeroplane.heading).toBeCloseTo(356)
        action.apply()
        expect(aeroplane.heading).toBeCloseTo(355)
        action.apply()
        expect(aeroplane.heading).toBe(355)
    })

    test("Turning right outside circle", () => {
        let currentHeading = 355;
        let desiredHeading = 5;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 220, currentHeading, 5000, 1)

        const action = new Heading({}, aeroplane, desiredHeading)

        expect(aeroplane.heading).toBe(355)
        action.apply()
        expect(aeroplane.heading).toBeCloseTo(359.4995)
        action.apply()
        expect(aeroplane.heading).toBeCloseTo(3.999)
        action.apply()
        expect(aeroplane.heading).toBe(5)
        action.apply()
        expect(aeroplane.heading).toBe(5)
    })

    test("Defaults to right turn within circle", () => {
        let currentHeading = 90;
        let desiredHeading = 270;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 220, currentHeading, 5000, 1)

        const action = new Heading({}, aeroplane, desiredHeading)

        expect(aeroplane.heading).toBe(90)
        action.apply()
        expect(aeroplane.heading).toBe(94.4995)
        action.apply()
        expect(aeroplane.heading).toBe(98.999)
        // etc.
    })

    test("Defaults to right turn from 0 to 180", () => {
        let currentHeading = 0;
        let desiredHeading = 180;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 220, currentHeading, 5000, 1)

        const action = new Heading({}, aeroplane, desiredHeading)

        expect(aeroplane.heading).toBe(0)
        action.apply()
        expect(aeroplane.heading).toBe(4.4995)
        action.apply()
        expect(aeroplane.heading).toBe(8.999)
        // etc.
    })

    test("Is not valid if the target heading is same as current heading", () => {
        let desiredAltitude = 243;

        expect(new Heading({}, {heading: 243}, desiredAltitude).isValid()).toBeFalsy()
    })

    test("Is not valid if the target heading is less than zero", () => {
        let desiredAltitude = -1;

        expect(new Heading({}, {heading: 243}, desiredAltitude).isValid()).toBeFalsy()
    })

    test("Is not valid if the target heading is greater than 360", () => {
        let desiredAltitude = 361;

        expect(new Heading({}, {heading: 243}, desiredAltitude).isValid()).toBeFalsy()
    })

    test.each`
    weight | speed | currentHeading | targetHeadingAfterFirstApply
    ${1} | ${180} | ${90} | ${94.5905}}
    ${1} | ${220} | ${90} | ${94.4995}}
    ${1} | ${320} | ${90} | ${94.272}}
    
    ${2} | ${180} | ${90} | ${93.5905}}
    ${2} | ${220} | ${90} | ${93.4995}}
    ${2} | ${320} | ${90} | ${93.272}}
    
    ${3} | ${180} | ${90} | ${92.5905}}
    ${3} | ${220} | ${90} | ${92.4995}}
    ${3} | ${320} | ${90} | ${92.272}}
  `("Aeroplane with weight $weight and speed $speed heading $currentHeading should head to $targetHeadingAfterFirstApply", (
        {weight, speed, currentHeading, targetHeadingAfterFirstApply}) => {
        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, speed, currentHeading, 3000, weight)
        aeroplane.setHeading({}, 180)

        expect(aeroplane.heading).toBe(currentHeading)

        aeroplane.applyActions()

        expect(aeroplane.heading).toBe(targetHeadingAfterFirstApply)
    })
})

describe("Altitude", () => {
    test("Creates altitude action with increasing altitude", () => {
        let currentAltitude = 1000;
        let desiredAltitude = 1100;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 200, 90, currentAltitude, 3)

        const action = new Altitude({}, aeroplane, desiredAltitude)

        expect(aeroplane.altitude).toBe(1000)
        action.apply()
        expect(aeroplane.altitude).toBe(1020)
        action.apply()
        expect(aeroplane.altitude).toBe(1040)
    })

    test("Creates altitude action with decreasing altitude", () => {
        let currentAltitude = 1100;
        let desiredAltitude = 1020;

        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 200, 90, currentAltitude, 3)

        const action = new Altitude({}, aeroplane, desiredAltitude)

        expect(aeroplane.altitude).toBe(1100)
        action.apply()
        expect(aeroplane.altitude).toBe(1080)
        action.apply()
        expect(aeroplane.altitude).toBe(1060)
    })

    test("Is not valid if the target altitude is below minimum altitude", () => {
        let desiredAltitude = MIN_ALTITUDE - 1;

        expect(new Altitude({}, {altitude: 3000}, desiredAltitude).isValid()).toBeFalsy()
    })

    test("Is not valid if the target altitude is above max altitude", () => {
        let desiredAltitude = MAX_ALTITUDE + 1;

        expect(new Altitude({}, {altitude: 3000}, desiredAltitude).isValid()).toBeFalsy()
    })

    test("Is not valid if the target altitude is same as current altitude", () => {
        let currentAltitude = 2000;

        expect(new Altitude({}, {altitude: currentAltitude}, currentAltitude).isValid()).toBeFalsy()
    })

    test("Is not valid if the target altitude is not multiple of 20", () => {
        let desiredAltitude = 2116;

        expect(new Altitude({}, {altitude: 3000}, desiredAltitude).isValid()).toBeFalsy()
    })
})

describe("Waypoint", () => {
    let map;
    beforeEach(() => {
        map = testGameMap()
    })

    test("Turns to face waypoint top right quadrant", () => {
        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 200, 90, 5000, 3)

        const action = new Waypoint(map, aeroplane, "LAM")

        expect(aeroplane.heading).toBe(90)
        action.apply()
        expect(aeroplane.heading).toBe(87)
        action.apply()
        expect(aeroplane.heading).toBe(84)
    })

    test("Turns to face waypoint bottom right quadrant", () => {
        const aeroplane = new Aeroplane("BA123", "A321", 300, 200, 200, 90, 5000, 3)

        const action = new Waypoint(map, aeroplane, "LAM")

        expect(aeroplane.heading).toBe(90)
        action.apply()
        expect(aeroplane.heading).toBe(93)
        action.apply()
        expect(aeroplane.heading).toBe(96)
    })

    test("Turns to face waypoint top left quadrant", () => {
        const aeroplane = new Aeroplane("BA123", "A321", 600, 600, 200, 90, 5000, 3)

        const action = new Waypoint(map, aeroplane, "LAM")

        expect(aeroplane.heading).toBe(90)
        action.apply()
        expect(aeroplane.heading).toBe(87)
        action.apply()
        expect(aeroplane.heading).toBe(84)
    })

    test("Turns to face waypoint bottom left quadrant", () => {
        const aeroplane = new Aeroplane("BA123", "A321", 1000, 200, 200, 90, 5000, 3)

        const action = new Waypoint(map, aeroplane, "LAM")

        expect(aeroplane.heading).toBe(90)
        action.apply()
        expect(aeroplane.heading).toBe(93)
        action.apply()
        expect(aeroplane.heading).toBe(96)
    })

    test("Turns to face LAM from slightly North West", () => {
        const aeroplane = new Aeroplane("BA123", "A321", 200, 800, 200, 355, 5000, 3)

        const action = new Waypoint(map, aeroplane, "LAM")

        expect(aeroplane.heading).toBe(355)
        action.apply()
        expect(aeroplane.heading).toBe(358)
        action.apply()
        expect(aeroplane.heading).toBe(1)
    })

    test("Is not valid if the waypoint does not exist", () => {
        const aeroplane = new Aeroplane("BA123", "A321", 500, 500, 200, 90, 5000, 3)
        let incorrectWaypoint = "BIP";

        expect(new Waypoint(map, aeroplane, incorrectWaypoint).isValid()).toBeFalsy()
    })

    test("Is actionable if far away from waypoint", () => {
        const aeroplane = new Aeroplane("BA123", "A321", 100, 672, 200, 90, 5000, 3)
        let waypoint = "LAM";

        expect(new Waypoint(map, aeroplane, waypoint).isActionable()).toBeTruthy()
    })

    test("Is not actionable if close to waypoint", () => {
        const aeroplane = new Aeroplane("BA123", "A321", 495, 505, 200, 90, 5000, 3)
        let waypoint = "LAM";

        expect(new Waypoint(map, aeroplane, waypoint).isActionable()).toBeFalsy()
    })
})

describe("Landing", () => {
    let map;
    beforeEach(() => {
        map = testGameMap()
    })

    test("Applies landing sequence actions", () => {
        const correctRunway = "27R";
        const speed = 190;
        const heading = 272;
        const altitude = 2800;
        const x = 710;
        const y = 555;

        const aeroplane = new Aeroplane("BA123", "A321", x, y, speed, heading, altitude, 3)

        expect(aeroplane.actions.length).toBe(0)
        const landing = new Landing(map, aeroplane, correctRunway);
        aeroplane.addAction(landing)

        expect(aeroplane.actions.length).toBe(1)

        aeroplane.applyActions()

        expect(aeroplane.actions.length).toBe(3)
        expect(aeroplane.actions[0].type()).toBe("Landing")
        expect(aeroplane.actions[1].type()).toBe("Speed")
        expect(aeroplane.actions[2].type()).toBe("Waypoint")

        expect(aeroplane.actions[0].executed).toBeFalsy()
    })

    test("Is valid if aeroplane is in correct landing configuration", () => {
        const correctRunway = "27R";
        const speed = 190;
        const heading = 272;
        const altitude = 2800;
        const x = 710;
        const y = 555;

        const landing = new Landing(map, {
            speed: speed,
            heading: heading,
            altitude: altitude,
            x: x,
            y: y
        }, correctRunway);
        expect(landing.isValid()).toBeTruthy()
    })

    test("Is not valid if the runway does not exist", () => {
        let incorrectRunway = "66C";

        const landing = new Landing(map, {}, incorrectRunway);
        expect(landing.isValid()).toBeFalsy()
    })

    test("Is not valid if the aeroplane is not within maximum X range of inner marker", () => {
        expect(new Landing(map, {x: 549, y: 450, heading: 90}, "9L").isValid()).toBeFalsy()
    })

    test("Is not valid if the aeroplane is not outside minimum X range of inner marker", () => {
        expect(new Landing(map, {x: 601, y: 450, heading: 90}, "9L").isValid()).toBeFalsy()
    })

    test("Is not valid if the aeroplane is to the other side of the runway", () => {
        expect(new Landing(map, {x: 800, y: 450, heading: 90}, "9L").isValid()).toBeFalsy()
    })

    test("Is not valid if the aeroplane is not within negative Y range of inner marker", () => {
        expect(new Landing(map, {x: 575, y: 429, heading: 90}, "9L").isValid()).toBeFalsy()
    })

    test("Is not valid if the aeroplane is not within positive Y range of inner marker", () => {
        expect(new Landing(map, {x: 575, y: 471, heading: 90}, "9L").isValid()).toBeFalsy()
    })

    test("Is not valid if the aeroplane is not within minimum angle of runway heading", () => {
        expect(new Landing(map, {x: 575, y: 450, heading: 101}, "9L").isValid()).toBeFalsy()
    })

    test("Is not valid if the aeroplane is not below maximum altitude for runway altitude", () => {
        expect(new Landing(map, {x: 575, y: 450, heading: 90, altitude: 3001}, "9L").isValid()).toBeFalsy()
    })

    test("Is not valid if the aeroplane is not above minimum altitude for runway altitude", () => {
        expect(new Landing(map, {x: 575, y: 450, heading: 90, altitude: 999}, "9L").isValid()).toBeFalsy()
    })

    test("Is not valid if the aeroplane is not below minimum approach speed", () => {
        expect(new Landing(map, {x: 575, y: 450, heading: 90, altitude: 2000, speed: 201}, "9L").isValid()).toBeFalsy()
    })
})

describe("Holding Pattern", () => {
    let map;
    beforeEach(() => {
        map = testGameMap()
    })

    test("Turns aeroplane to correct heading when turning left across 0", () => {
        const holdDirection = -1;
        const speed = 190;
        const heading = 3;
        const weight = 1;
        const x = 500;
        const y = 500;

        const aeroplane = new Aeroplane("123", "", x, y, speed, heading, 3000, weight)
        const hold = new HoldingPattern(map, aeroplane, holdDirection);

        expect(aeroplane.heading).toBe(3)

        hold.apply()

        expect(aeroplane.heading).toBe(358)
    })

    test("Turns aeroplane to correct heading when turning right across 0", () => {
        const holdDirection = 1;
        const speed = 190;
        const heading = 358;
        const weight = 1;
        const x = 500;
        const y = 500;

        const aeroplane = new Aeroplane("123", "", x, y, speed, heading, 3000, weight)
        const hold = new HoldingPattern(map, aeroplane, holdDirection);

        expect(aeroplane.heading).toBe(358)

        hold.apply()

        expect(aeroplane.heading).toBe(3)
    })

    test("Is always valid", () => {
        const hold = new HoldingPattern(map, {}, "anything");
        expect(hold.isValid()).toBeTruthy()
    })

    test("Is always actionable", () => {
        const hold = new HoldingPattern(map, {}, 1);
        expect(hold.isActionable()).toBeTruthy()
    })
})

